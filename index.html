<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Face Verification</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --primary: #6739B7;
    --light: #C3A0EC;
    --lighter: #EDE0FF;
    --dark: #3A1F7A;
    --bg: #0D0820;
    --surface: #1A1035;
    --text: #F0E8FF;
    --muted: #9B82C8;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Outfit', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    position: relative;
  }

  /* Ambient glow background */
  body::before {
    content: '';
    position: fixed;
    top: -30%;
    left: -20%;
    width: 70vw;
    height: 70vw;
    background: radial-gradient(circle, rgba(103,57,183,0.25) 0%, transparent 70%);
    pointer-events: none;
  }
  body::after {
    content: '';
    position: fixed;
    bottom: -20%;
    right: -15%;
    width: 55vw;
    height: 55vw;
    background: radial-gradient(circle, rgba(195,160,236,0.12) 0%, transparent 70%);
    pointer-events: none;
  }

  .container {
    width: 100%;
    max-width: 420px;
    padding: 24px 20px 40px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0;
    position: relative;
    z-index: 1;
  }

  /* Logo / Brand */
  .brand {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 30px;
  }
  .brand-icon {
    width: 36px;
    height: 36px;
    background: linear-gradient(135deg, var(--primary), var(--light));
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .brand-icon svg { width: 20px; height: 20px; fill: white; }
  .brand-name {
    font-size: 18px;
    font-weight: 700;
    color: var(--text);
    letter-spacing: -0.3px;
  }

  /* Heading */
  .heading {
    text-align: center;
    margin-bottom: 28px;
  }
  .heading h1 {
    font-size: 26px;
    font-weight: 700;
    letter-spacing: -0.5px;
    line-height: 1.2;
    background: linear-gradient(135deg, var(--text) 40%, var(--light));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 8px;
  }
  .heading p {
    font-size: 14px;
    color: var(--muted);
    line-height: 1.5;
  }

  /* Camera viewport */
  .cam-wrap {
    position: relative;
    width: 100%;
    aspect-ratio: 3/4;
    max-height: 380px;
    border-radius: 28px;
    overflow: hidden;
    background: var(--surface);
    box-shadow: 0 0 0 2px rgba(195,160,236,0.2), 0 20px 60px rgba(0,0,0,0.5);
    margin-bottom: 20px;
  }

  video, canvas#snapshot {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    transform: scaleX(-1); /* mirror front cam */
  }

  canvas#snapshot { display: none; position: absolute; top: 0; left: 0; }

  /* Face guide overlay */
  .face-guide {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -54%);
    width: 68%;
    aspect-ratio: 3/4;
    border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
    border: 2.5px solid rgba(195,160,236,0.5);
    pointer-events: none;
    animation: pulse-border 2.5s ease-in-out infinite;
  }

  /* Corner brackets */
  .face-guide::before,
  .face-guide::after {
    content: '';
    position: absolute;
    width: 24px;
    height: 24px;
    border-color: var(--light);
    border-style: solid;
  }
  .face-guide::before {
    top: -2px; left: -2px;
    border-width: 3px 0 0 3px;
    border-radius: 6px 0 0 0;
  }
  .face-guide::after {
    bottom: -2px; right: -2px;
    border-width: 0 3px 3px 0;
    border-radius: 0 0 6px 0;
  }

  @keyframes pulse-border {
    0%, 100% { border-color: rgba(195,160,236,0.5); box-shadow: 0 0 0 0 rgba(195,160,236,0); }
    50% { border-color: rgba(195,160,236,0.9); box-shadow: 0 0 18px 4px rgba(195,160,236,0.15); }
  }

  /* Scan line animation */
  .scan-line {
    position: absolute;
    left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--light), transparent);
    animation: scan 2.5s ease-in-out infinite;
    opacity: 0.7;
  }
  @keyframes scan {
    0% { top: 15%; opacity: 0; }
    10% { opacity: 0.7; }
    90% { opacity: 0.7; }
    100% { top: 85%; opacity: 0; }
  }

  /* Status label */
  .status-badge {
    position: absolute;
    bottom: 14px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(13,8,32,0.75);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(195,160,236,0.25);
    border-radius: 20px;
    padding: 6px 16px;
    font-size: 12px;
    font-weight: 600;
    color: var(--light);
    letter-spacing: 0.5px;
    white-space: nowrap;
    transition: all 0.4s ease;
  }

  /* Location row */
  .location-row {
    display: flex;
    align-items: center;
    gap: 8px;
    background: rgba(103,57,183,0.12);
    border: 1px solid rgba(103,57,183,0.3);
    border-radius: 14px;
    padding: 10px 16px;
    font-size: 12px;
    color: var(--muted);
    width: 100%;
    margin-bottom: 20px;
    min-height: 44px;
  }
  .location-row svg { flex-shrink: 0; }
  #location-text { flex: 1; word-break: break-all; line-height: 1.4; }

  /* GitHub config section */
  .config-card {
    width: 100%;
    background: rgba(26,16,53,0.8);
    border: 1px solid rgba(103,57,183,0.35);
    border-radius: 18px;
    padding: 18px;
    margin-bottom: 20px;
  }
  .config-card h3 {
    font-size: 13px;
    font-weight: 600;
    color: var(--light);
    margin-bottom: 14px;
    letter-spacing: 0.3px;
  }
  .field {
    margin-bottom: 12px;
  }
  .field label {
    display: block;
    font-size: 11px;
    color: var(--muted);
    margin-bottom: 5px;
    font-weight: 500;
    letter-spacing: 0.3px;
  }
  .field input {
    width: 100%;
    background: rgba(103,57,183,0.1);
    border: 1px solid rgba(103,57,183,0.3);
    border-radius: 10px;
    padding: 10px 12px;
    font-family: 'Outfit', sans-serif;
    font-size: 13px;
    color: var(--text);
    outline: none;
    transition: border-color 0.2s;
  }
  .field input:focus { border-color: var(--light); }
  .field input::placeholder { color: rgba(155,130,200,0.5); }

  /* CTA Button */
  .btn {
    width: 100%;
    padding: 16px;
    border-radius: 16px;
    border: none;
    font-family: 'Outfit', sans-serif;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    letter-spacing: 0.3px;
    transition: all 0.25s ease;
    position: relative;
    overflow: hidden;
  }
  .btn-primary {
    background: linear-gradient(135deg, var(--primary) 0%, #9B59D0 100%);
    color: white;
    box-shadow: 0 8px 30px rgba(103,57,183,0.45);
  }
  .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 12px 40px rgba(103,57,183,0.6); }
  .btn-primary:active { transform: translateY(0); }
  .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

  .btn-secondary {
    background: rgba(103,57,183,0.15);
    color: var(--light);
    border: 1px solid rgba(103,57,183,0.4);
    margin-top: 10px;
    display: none;
  }

  /* Result message */
  .result-msg {
    margin-top: 14px;
    padding: 12px 16px;
    border-radius: 12px;
    font-size: 13px;
    line-height: 1.5;
    display: none;
    width: 100%;
    text-align: center;
  }
  .result-msg.success {
    background: rgba(103,57,183,0.2);
    border: 1px solid rgba(103,57,183,0.5);
    color: var(--light);
    display: block;
  }
  .result-msg.error {
    background: rgba(220,50,50,0.15);
    border: 1px solid rgba(220,50,50,0.4);
    color: #FF9090;
    display: block;
  }

  /* Spinner */
  @keyframes spin { to { transform: rotate(360deg); } }
  .spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
    vertical-align: middle;
    margin-right: 8px;
  }

  /* Flash effect on capture */
  .flash {
    position: fixed;
    inset: 0;
    background: white;
    opacity: 0;
    pointer-events: none;
    z-index: 999;
    animation: flash-anim 0.4s ease forwards;
  }
  @keyframes flash-anim {
    0% { opacity: 0.8; }
    100% { opacity: 0; }
  }
</style>
</head>
<body>

<div class="container">
  <div class="brand">
    <div class="brand-icon">
      <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>
    </div>
    <span class="brand-name">VerifyID</span>
  </div>

  <div class="heading">
    <h1>Verifying Face Data</h1>
    <p>Position your face within the oval guide. Stay still while we capture and verify your identity.</p>
  </div>

  <!-- Camera -->
  <div class="cam-wrap">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="snapshot"></canvas>
    <div class="face-guide"></div>
    <div class="scan-line" id="scanLine"></div>
    <div class="status-badge" id="statusBadge">Initializing camera‚Ä¶</div>
  </div>

  <!-- Location -->
  <div class="location-row">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#C3A0EC" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/>
    </svg>
    <span id="location-text">Fetching location‚Ä¶</span>
  </div>

  <!-- GitHub Config -->
  <div class="config-card">
    <h3>üîß GitHub Upload Settings</h3>
    <div class="field">
      <label>GITHUB TOKEN (classic, repo scope)</label>
      <input type="password" id="ghToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
    </div>
    <div class="field">
      <label>REPO (owner/repo-name)</label>
      <input type="text" id="ghRepo" placeholder="yourusername/your-repo">
    </div>
  </div>

  <!-- Capture button -->
  <button class="btn btn-primary" id="captureBtn" disabled>
    Capture &amp; Verify
  </button>
  <button class="btn btn-secondary" id="retakeBtn">
    Retake
  </button>
  <div class="result-msg" id="resultMsg"></div>
</div>

<script>
const video = document.getElementById('video');
const snapshotCanvas = document.getElementById('snapshot');
const statusBadge = document.getElementById('statusBadge');
const captureBtn = document.getElementById('captureBtn');
const retakeBtn = document.getElementById('retakeBtn');
const resultMsg = document.getElementById('resultMsg');
const locationText = document.getElementById('location-text');

let coords = null;
let locationStr = 'Unknown';
let stream = null;
let captured = false;

// === START CAMERA ===
async function startCamera() {
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } },
      audio: false
    });
    video.srcObject = stream;
    video.onloadedmetadata = () => {
      statusBadge.textContent = 'Align face in oval';
      captureBtn.disabled = false;
    };
  } catch(e) {
    statusBadge.textContent = 'Camera access denied';
    resultMsg.className = 'result-msg error';
    resultMsg.textContent = '‚ö†Ô∏è Camera permission denied. Please allow camera access and reload.';
  }
}

// === GEOLOCATION ===
function getLocation() {
  if (!navigator.geolocation) {
    locationText.textContent = 'Geolocation not supported';
    return;
  }
  navigator.geolocation.getCurrentPosition(pos => {
    coords = { lat: pos.coords.latitude, lng: pos.coords.longitude, accuracy: pos.coords.accuracy };
    locationStr = `${coords.lat.toFixed(6)}, ${coords.lng.toFixed(6)} (¬±${Math.round(coords.accuracy)}m)`;
    locationText.innerHTML = `üìç ${locationStr} ‚Äî <a href="https://maps.google.com/?q=${coords.lat},${coords.lng}" target="_blank" style="color:var(--light)">View Map</a>`;
  }, err => {
    locationText.textContent = 'Location unavailable ‚Äî ' + err.message;
    locationStr = 'Location denied';
  }, { enableHighAccuracy: true });
}

// === CAPTURE ===
captureBtn.addEventListener('click', async () => {
  if (captured) return;

  const token = document.getElementById('ghToken').value.trim();
  const repo = document.getElementById('ghRepo').value.trim();
  if (!token || !repo) {
    showMsg('error', '‚ö†Ô∏è Please enter your GitHub token and repository name above.');
    return;
  }

  // Flash
  const flashEl = document.createElement('div');
  flashEl.className = 'flash';
  document.body.appendChild(flashEl);
  setTimeout(() => flashEl.remove(), 500);

  // Draw to canvas
  snapshotCanvas.width = video.videoWidth;
  snapshotCanvas.height = video.videoHeight;
  const ctx = snapshotCanvas.getContext('2d');
  ctx.translate(snapshotCanvas.width, 0);
  ctx.scale(-1, 1);
  ctx.drawImage(video, 0, 0);

  // Embed metadata as text overlay
  ctx.setTransform(1, 0, 0, 1, 0, 0);
  ctx.fillStyle = 'rgba(0,0,0,0.55)';
  ctx.fillRect(0, snapshotCanvas.height - 38, snapshotCanvas.width, 38);
  ctx.fillStyle = 'white';
  ctx.font = `${Math.max(12, snapshotCanvas.width * 0.022)}px monospace`;
  ctx.fillText(`üìç ${locationStr}  |  ${new Date().toISOString()}`, 10, snapshotCanvas.height - 14);

  // Stop camera, show snapshot
  stream.getTracks().forEach(t => t.stop());
  video.style.display = 'none';
  snapshotCanvas.style.display = 'block';
  snapshotCanvas.style.transform = 'none';
  captured = true;

  statusBadge.textContent = 'Uploading‚Ä¶';
  captureBtn.disabled = true;
  captureBtn.innerHTML = '<span class="spinner"></span> Uploading to GitHub‚Ä¶';
  retakeBtn.style.display = 'block';

  // Convert to base64
  const base64 = snapshotCanvas.toDataURL('image/jpeg', 0.92).split(',')[1];

  // Filename with timestamp + coords
  const ts = new Date().toISOString().replace(/[:.]/g, '-');
  const locTag = coords ? `_${coords.lat.toFixed(4)}_${coords.lng.toFixed(4)}` : '';
  const filename = `images/face_${ts}${locTag}.jpg`;

  await uploadToGitHub(token, repo, filename, base64);
});

// === GITHUB UPLOAD ===
async function uploadToGitHub(token, repo, path, base64Content) {
  const url = `https://api.github.com/repos/${repo}/contents/${path}`;

  // Build commit message with location
  const message = `Face verification capture ‚Äî ${new Date().toISOString()} | Location: ${locationStr}`;

  try {
    const res = await fetch(url, {
      method: 'PUT',
      headers: {
        'Authorization': `token ${token}`,
        'Content-Type': 'application/json',
        'Accept': 'application/vnd.github.v3+json'
      },
      body: JSON.stringify({ message, content: base64Content })
    });

    const data = await res.json();

    if (res.ok) {
      statusBadge.textContent = '‚úì Verified & Saved';
      captureBtn.innerHTML = '‚úì Done';
      showMsg('success', `‚úÖ Image saved to GitHub!\nüìÅ ${path}\nüìç Location: ${locationStr}\nüîó <a href="${data.content?.html_url}" target="_blank" style="color:var(--light)">View file on GitHub</a>`);
    } else {
      throw new Error(data.message || 'Upload failed');
    }
  } catch(e) {
    statusBadge.textContent = '‚úó Upload failed';
    captureBtn.innerHTML = 'Upload Failed';
    showMsg('error', `‚ùå GitHub upload failed: ${e.message}\n\nCheck your token (needs repo scope) and repo name.`);
  }
}

// === RETAKE ===
retakeBtn.addEventListener('click', () => {
  captured = false;
  snapshotCanvas.style.display = 'none';
  video.style.display = 'block';
  resultMsg.className = 'result-msg';
  resultMsg.textContent = '';
  captureBtn.disabled = false;
  captureBtn.innerHTML = 'Capture &amp; Verify';
  retakeBtn.style.display = 'none';
  statusBadge.textContent = 'Align face in oval';
  startCamera();
});

function showMsg(type, html) {
  resultMsg.className = `result-msg ${type}`;
  resultMsg.innerHTML = html.replace(/\n/g, '<br>');
}

// Init
startCamera();
getLocation();
</script>
</body>
</html>
